*filter

# Politiche di default
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

-A INPUT -p ipv6-icmp -j DROP
-A FORWARD -p ipv6-icmp -j DROP
-A OUTPUT -p ipv6-icmp -j DROP

# === Accesso di base ===
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# === Protezioni base (DoS e scansioni) ===

# Filtro SYN flood base
-N DOS_FILTER
-A DOS_FILTER -m limit --limit 50/second --limit-burst 100 -j RETURN
-A DOS_FILTER -j DROP
-A INPUT   -p tcp --syn -j DOS_FILTER
-A FORWARD -p tcp --syn -j DOS_FILTER

# Rate limit ICMP
-A INPUT -p icmp --icmp-type echo-request -m limit --limit 10/s --limit-burst 20 -j ACCEPT
-A INPUT -p icmp --icmp-type echo-request -j DROP

# === Accesso SSH (solo da reti fidate) ===
-A INPUT -p tcp -s 10.10.1.0/24 --dport 22 -j ACCEPT
-A INPUT -p tcp -s 10.10.2.0/24 --dport 22 -j ACCEPT
-A INPUT -p tcp -s 10.10.4.0/24 --dport 22 -j DROP

# === Accesso PEP / PDP / Squid ===
-A INPUT -p tcp -s 10.10.1.0/24 --dport 8002 -j ACCEPT
-A INPUT -p tcp -s 10.10.2.0/24 --dport 8002 -j ACCEPT
-A INPUT -p tcp -s 10.10.3.0/24 --dport 8002 -j ACCEPT
-A INPUT -p tcp -s 10.10.4.0/24 --dport 8002 -j DROP

-A INPUT -p tcp -s 10.10.1.0/24 --dport 8001 -j ACCEPT
-A INPUT -p tcp --dport 8001 -j DROP

-A INPUT -p tcp -s 10.10.1.0/24 --dport 3128 -j ACCEPT
-A INPUT -p tcp -s 10.10.2.0/24 --dport 3128 -j ACCEPT
-A INPUT -p tcp -s 10.10.3.0/24 --dport 3128 -j ACCEPT

-A INPUT -p tcp --dport 3129 -j ACCEPT

# === Traffico FORWARD tra reti ===
-A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Consenti traffico tra reti aziendali
-A FORWARD -s 10.10.1.0/24 -d 10.10.4.0/24 -p tcp -m multiport --dports 80,443,21 -j ACCEPT
-A FORWARD -s 10.10.1.0/24 -d 10.10.4.0/24 -p icmp --icmp-type echo-request -j ACCEPT
-A FORWARD -s 10.10.2.0/24 -d 10.10.4.0/24 -p tcp -m multiport --dports 80,443,21 -j ACCEPT
-A FORWARD -s 10.10.2.0/24 -d 10.10.4.0/24 -p icmp --icmp-type echo-request -j ACCEPT
-A FORWARD -s 10.10.3.0/24 -d 10.10.4.0/24 -p tcp -m multiport --dports 80,443,21 -j ACCEPT
-A FORWARD -s 10.10.3.0/24 -d 10.10.4.0/24 -p icmp --icmp-type echo-request -j ACCEPT
-A FORWARD -s 10.10.4.0/24 -d 10.10.3.0/24 -p tcp --dport 5000 -j ACCEPT

# Da PEP a Server
-A FORWARD -s 10.10.3.222 -d 10.10.4.0/24 -p tcp -j ACCEPT
-A FORWARD -s 10.10.3.222 -d 10.10.4.0/24 -p icmp --icmp-type echo-request -j ACCEPT
-A FORWARD -s 10.10.3.222 -d 10.10.4.0/24 -p icmp --icmp-type echo-reply -j ACCEPT

COMMIT

*nat

:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# === Redirezione per proxy trasparente Squid (porta 3129) ===
-A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3129
-A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3129

# === NAT: abilita routing da rete pubblica verso l'esterno ===
# Usa MASQUERADE generico senza -o
-A POSTROUTING -s 10.10.5.0/24 -j MASQUERADE

COMMIT
