# === 1. Porta proxy HTTP classica ===
http_port 3128

# === 2. ACL per subnet ===
acl rete_aziendale src 10.10.1.0/24
acl rete_vpn src 10.10.2.0/24
acl rete_domestica src 10.10.3.0/24
acl rete_pubblica src 10.10.4.0/24

# === 3. ACL per porte sicure e CONNECT ===
acl SSL_ports  port 443
acl Safe_ports port 80
acl CONNECT    method CONNECT
http_access allow CONNECT SSL_ports

# === 4. ACL per policy di sicurezza ===
acl metodo_post method POST
acl url_operazione url_regex -i /operazione
acl risorsa_sensibile url_regex -i Cartella.Clinica|Dati.Sanitari|Profilo.Biometrico

# ACL su header (opzionali se supportati dal client)
acl dispositivo_privato req_header X-Dispositivo privato
acl rete_pubblica_hdr req_header X-Rete pubblica

# === 5. HTTP access rules ===

# -- Blocco policy: scrittura su risorse sensibili da rete pubblica o dispositivi privati
http_access deny rete_pubblica metodo_post risorsa_sensibile
http_access deny dispositivo_privato metodo_post risorsa_sensibile

# -- Blocco generico POST verso endpoint operazione da rete pubblica
http_access deny rete_pubblica metodo_post url_operazione

# -- Consenti le reti fidate
http_access allow rete_aziendale
http_access allow rete_vpn
http_access allow rete_domestica

# Blocco finale
http_access deny all

# === 6. Cache e risorse ===
cache_mem 256 MB
maximum_object_size_in_memory 8 MB
maximum_object_size 128 MB

# === 7. Logging ===
access_log stdio:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# === 8. Header per debug/tracciamento ===
request_header_add X-Rete Aziendale rete_aziendale
request_header_add X-Rete VPN rete_vpn
request_header_add X-Rete Domestica rete_domestica
request_header_access X-Rete allow all
request_header_access X-Dispositivo allow all
